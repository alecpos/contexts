# Stripe Integration Guide

This guide explains how to integrate new Stripe features using the `StripeProvider` and plain HTTP requests.

## Environment Setup

Create a `.env` file based on `.env.example` and set the following keys:

```env
STRIPE_PK=<publishable key>
STRIPE_SK=<secret key>
```

Use test mode keys during development.

## Provider Workflow

All Stripe logic is isolated in `StripeProvider`. Wrap your application with this provider and access values through `useStripe()`:

```tsx
import { StripeProvider, useStripe } from './providers/StripeProvider'

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return <StripeProvider>{children}</StripeProvider>
}
```

The provider creates a customer and setup intent on mount using `fetch`/`curl` to Stripe's API. The resulting `customerId` and `clientSecret` are exposed via the context.

## Example Usage

```tsx
'use client'
import { useStripe } from '@/app/providers/StripeProvider'

export default function CheckoutButton() {
  const { clientSecret, customerId } = useStripe()

  useEffect(() => {
    if (!clientSecret) return
    fetch('/api/charge', {
      method: 'POST',
      body: JSON.stringify({ customerId, clientSecret }),
    })
  }, [clientSecret])

  return <button>Pay</button>
}
```

## Running Tests

Execute Jest to validate that the provider creates real Stripe objects:

```bash
npm test
```

Tests live under `providers/__tests__/` and hit the Stripe API using curl.

## Additional HTTP Helpers

Utility functions in `services/stripe/http.ts` cover common REST endpoints.
New helpers include creating and attaching payment methods and updating or
deleting customers. When creating a payment method you **must** use a token such
as `tok_visa`:

```bash
curl https://api.stripe.com/v1/payment_methods \
  -u $STRIPE_SK: \
  -d type=card \
  -d card[token]=tok_visa
```

Recent tests also covered listing and updating payment intents, retrieving setup
intents, and detaching payment methods. Capturing a payment intent that hasn't
been confirmed will fail with an `invalid_request_error`. Use `capture_method=manual`
and confirm the intent before calling `/capture`.


Sending raw card numbers to `/payment_methods` returns an error, so always rely
on tokens generated by Stripe.
